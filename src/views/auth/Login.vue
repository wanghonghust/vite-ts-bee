<template>
  <div class="login-content">
    <div class="login-main">
      <div class="logo">
        <svg t="1665709098362" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2885" width="80" height="80"><path d="M557.72 546.68c-190.93-45.82-389.74 43.05-424.83 171.63 9.09 34.76 30.26 70.79 66.13 106.66 172.71 172.71 349.13 4.95 369.18-213.77-1.88-21.44-5.32-43.03-10.48-64.52z" fill="#FFC700" opacity=".5" p-id="2886"></path><path d="M521.3 347.18c14.16 36.72 26.48 76.65 36.62 118.9 70.1 16.82 133.99 39.55 187 66.95 8.43-15.6 14.49-32.15 18.17-49.11-7.49-33.5-24.25-65.34-50.32-91.41-51.8-51.79-126.36-66.86-191.47-45.33z" fill="#FFC700" opacity=".5" p-id="2887"></path><path d="M345.66 919.64c-10.96 0-21.96-1.02-32.91-3.08-45-8.46-88.8-33.73-130.19-75.12-41.39-41.39-66.66-85.19-75.12-130.19-7.87-41.88-0.58-84.46 21.07-123.14 14.04-25.08 33.68-48.19 58.5-68.85-4.75-8.75-9.25-17.51-13.5-26.25-38.33-78.96-54.52-153.73-46.83-216.25 3.77-30.59 13.23-58.23 28.13-82.17 15.83-25.42 37.82-46.69 65.35-63.21 25.36-15.21 51.17-24.11 76.71-26.44 24.92-2.28 49.66 1.66 73.55 11.68 87.83 36.87 162.79 156.85 206.71 330.21 173.37 43.92 293.35 118.88 330.21 206.71 10.03 23.89 13.96 48.64 11.68 73.55-2.33 25.54-11.23 51.35-26.44 76.71-16.52 27.53-37.79 49.52-63.21 65.35-23.93 14.9-51.58 24.37-82.17 28.13-10.13 1.25-20.58 1.87-31.32 1.87-55.54 0-118.76-16.57-184.93-48.7-8.74-4.24-17.49-8.75-26.25-13.5-20.67 24.82-43.77 44.46-68.85 58.5-28.53 16.03-59.22 24.19-90.19 24.19zM211 560.13c-17.52 15.55-31.73 32.65-41.86 50.73-16.49 29.44-21.85 60.33-15.94 91.79 6.69 35.61 27.65 71.23 62.28 105.86 34.64 34.64 70.25 55.59 105.86 62.28 31.46 5.91 62.34 0.55 91.79-15.94 18.08-10.13 35.19-24.33 50.73-41.86-49.71-31.36-98.04-69.89-140.51-112.36-42.46-42.46-80.99-90.79-112.35-140.5z m321.06 238.68a612.65 612.65 0 0 0 19.26 9.79c70.86 34.4 136.64 49.1 190.22 42.5 49.01-6.03 86.4-30 111.14-71.23 22.65-37.75 26.5-73.17 11.75-108.29-29.24-69.66-131.47-133.46-276.57-173.72 11.47 74.38 4.97 151.95-19.01 222.05-9.79 28.63-22.12 55.05-36.79 78.9zM248.51 532.34c29.82 47.8 66.83 94.43 107.77 135.38 40.94 40.94 87.57 77.96 135.38 107.77 13.09-21.08 24.32-44.88 33.14-70.65 23.66-69.16 28.38-146.46 13.6-219.24-72.78-14.78-150.08-10.06-219.24 13.6-25.77 8.81-49.57 20.05-70.65 33.14z m61.96-381.53c-21.56 0-43.52 6.82-66.34 20.51-41.23 24.74-65.2 62.13-71.23 111.14-6.6 53.58 8.1 119.36 42.5 190.22 3.11 6.41 6.38 12.83 9.79 19.26 23.85-14.67 50.27-27 78.9-36.79 70.1-23.98 147.66-30.48 222.05-19.01-40.26-145.09-104.06-247.32-173.72-276.57-13.89-5.84-27.83-8.76-41.95-8.76z" fill="#3F2704" p-id="2888"></path><path d="M744.9 556.32c-3.6 0-7.26-0.84-10.68-2.61-51.19-26.47-112.34-48.34-181.74-65a23.268 23.268 0 0 1-17.2-17.21c-16.66-69.4-38.52-130.54-65-181.74-5.83-11.27-1.56-25.14 9.61-31.17 39.09-21.12 84.96-29.39 129.17-23.27 45.73 6.33 87.2 26.96 119.92 59.69s53.36 74.19 59.69 119.92c6.11 44.21-2.15 90.08-23.27 129.17-4.21 7.78-12.22 12.22-20.5 12.22zM577.15 446.85c58 14.7 110.49 33.05 156.54 54.7 9.45-25.41 12.6-53.21 8.86-80.23-4.92-35.6-21-67.89-46.49-93.38-25.49-25.49-57.78-41.57-93.38-46.49-27.02-3.74-54.82-0.59-80.23 8.86 21.66 46.05 40 98.54 54.7 156.54zM695.43 216.65c-6.96 0-13.92-2.65-19.22-7.95-5.14-5.14-7.96-11.96-7.96-19.22 0-7.26 2.83-14.09 7.96-19.22 5.13-5.13 11.96-7.96 19.22-7.96 7.26 0 14.09 2.83 19.23 7.96 10.59 10.59 10.6 27.84 0 38.44l-0.01 0.01c-5.3 5.29-12.26 7.94-19.22 7.94zM824.45 345.67c-6.96 0-13.92-2.65-19.22-7.95-5.13-5.13-7.96-11.96-7.96-19.22 0-7.26 2.83-14.09 7.96-19.22 10.6-10.6 27.84-10.59 38.44 0 10.6 10.6 10.6 27.85 0 38.45-5.3 5.29-12.26 7.94-19.22 7.94z" fill="#3F2704" p-id="2889"></path></svg>
        <span>Admin</span>
      </div>
      <el-tabs v-model="activeName" class="login-tabs" type="card">
        <el-tab-pane label="账号密码登录" name="first">
          <el-form ref="ruleFormRef" :model="ruleForm" status-icon :rules="rules" label-width="120px" size="large"
                   label-position="right">
            <el-form-item prop="username">
              <el-input v-model="ruleForm.username" type="text" autocomplete="off" placeholder="请输入账号">
                <template #prefix>
                  <el-icon class="el-input__icon">
                    <userFilled/>
                  </el-icon>
                </template>
              </el-input>
            </el-form-item>
            <el-form-item prop="password">
              <el-input v-model="ruleForm.password" type="text" autocomplete="off" show-password placeholder="请输入密码">
                <template #prefix>
                  <el-icon class="el-input__icon">
                    <lock/>
                  </el-icon>
                </template>
              </el-input>
            </el-form-item>
            <el-button type="primary" @click="submitForm(ruleFormRef)">登录</el-button>
          </el-form>
        </el-tab-pane>
        <el-tab-pane label="短信登录" name="second">
          <el-form>
            <el-form-item prop="number">
              <el-input v-model="ruleForm.username" type="text" autocomplete="off" placeholder="请输入手机号">
                <template #prefix>
                  <el-icon class="el-input__icon">
                    <Cellphone/>
                  </el-icon>
                </template>
              </el-input>
            </el-form-item>
            <el-form-item prop="code">
              <el-row style="margin-right: 2rem;">
                <el-col :span="16">
                  <el-input v-model="ruleForm.password" class="code" type="text" autocomplete="off" show-password
                            placeholder="请输入验证码">
                    <template #prefix>
                      <el-icon class="el-input__icon">
                        <lock/>
                      </el-icon>
                    </template>
                  </el-input>
                </el-col>
                <el-col :span="8">
                  <el-button type="primary" class="code-button" :disabled="btnDisabled" @click="getActCode">
                    {{ codeBtnText }}
                  </el-button>
                </el-col>
              </el-row>
            </el-form-item>
            <el-button type="primary" @click="submitForm(ruleFormRef)" size="large">登录</el-button>
          </el-form>
        </el-tab-pane>

      </el-tabs>
    </div>
  </div>

</template>


<script lang="ts" setup>
import {reactive, ref} from 'vue'
import {ElMessage, FormInstance} from 'element-plus'
import {login} from "../../api/auth";
import router from "../../router";
import {Session} from "../../utils/storage";

const codeBtnText = ref("获取验证码")
const btnDisabled = ref(false)
const activeName = ref('first')
const logo = ref("/src/assets/OIP-C.png")
const ruleFormRef = ref<FormInstance>()
const getActCode = () => {
  let tmp = 60
  btnDisabled.value = true
  let inter = setInterval(() => {
    codeBtnText.value = String(tmp)
    tmp = tmp - 1
    if (tmp == -1) {
      clearInterval(inter)
      codeBtnText.value = "获取验证码"
      btnDisabled.value = false
    }

  }, 1000)
}

const validateUsername = (rule: any, value: any, callback: any) => {
  if (value === '') {
    callback(new Error('请输入用户账号！'))
  } else {
    callback()
  }
}
const validatePass = (rule: any, value: any, callback: any) => {
  if (value === '') {
    callback(new Error('请输入密码！'))
  } else {
    callback()
  }
}

const ruleForm = reactive({
  username: 'admin',
  password: '123456',
})

const rules = reactive({
  username: [{validator: validateUsername, trigger: 'blur'}],
  password: [{validator: validatePass, trigger: 'blur'}],
})

const submitForm = (formEl: FormInstance | undefined) => {
  if (!formEl) return
  formEl.validate((valid) => {
    if (valid) {
      login(ruleForm).then(async (res: any) => {
        Session.set("token", res.data.data.token)
        Session.set("user", res.data.data.user)
        Session.set("username", res.data.data.username)
        Session.set("email", res.data.data.email)
        Session.set("avatar", res.data.data.avatar)
        Session.set("createAt", res.data.data.createAt)
        const redirect = router.currentRoute.value.query.redirect
        if (redirect) {
          router.push(redirect)
        } else {
          router.push("/index")
        }
        ElMessage({
          message: '登录成功！',
          type: 'success',
        })
      }).catch((error: any) => {
        const status = error.response.status
        if (status === 403) {
          ElMessage({
            message: '用户已被禁用，请联系管理员处理！',
            type: 'error',
          })
        } else if (status === 401) {
          ElMessage({
            message: '登录失败，请检查账号、密码是否正确！',
            type: 'error',
          })
        } else {
          ElMessage({
            message: '网络连接错误！',
            type: 'error',
          })
        }

      })
    } else {
      return false
    }
  })
}

const resetForm = (formEl: FormInstance | undefined) => {
  if (!formEl) return
  formEl.resetFields()
}
</script>

<style scoped>
.login-tabs > .el-tabs__content {
  padding: 32px;
  color: #6b778c;
  font-size: 32px;
  font-weight: 600;
}

.login-content {
  width: 100vw;
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 10%;
  /*background-image: url("/src/assets/bg.jpg");*/
  background-size: cover;
}

.login-main {
  width: 350px;
  padding: 2rem 2rem;
  background: rgb(145 145 145 / 20%);
  border-radius: 10px;
  backdrop-filter: blur(5px);
  box-shadow: 0 5px 15px rgb(193 193 193 / 80%);
}

:deep(.el-tabs__content) {
  border-radius: 10px;
}

:deep(.el-tabs--card>.el-tabs__header) {
  border: none;
  padding: 0 2rem;
  margin-bottom: 2rem;
}

:deep(.el-tabs--card>.el-tabs__header .el-tabs__item) {
  border: none;
}

:deep(.el-tabs--card>.el-tabs__header .el-tabs__nav) {
  border: none;
}

@media screen and (max-width: 480px) {
  .login-main {
    width: calc(100% - 90px);
  }

  :deep(.el-input__wrapper) {
    margin: 0 1rem !important;
  }

  .el-button {
    margin: 0 1rem !important;
    width: calc(100% - 2rem) !important;
    height: 42px;
  }

  .code-button {
    margin: 0 !important;
    width: calc(100% + 15px) !important;
    height: 42px;
  }
}

.el-input {
  width: 100%;
}

.el-form-item {
  margin-bottom: 28px;
}

:deep(.el-input__wrapper) {
  margin: 0 2rem;
  height: 40px;
  padding: 1px 15px;
}

:deep(.el-form-item__content) {
  margin-left: 0 !important;
}

:deep(.el-form-item__error) {
  font-size: 14px;
  padding-left: 2rem;
}


.el-button {
  margin: 0 2rem;
  width: calc(100% - 4rem);
}

.logo {
  display: flex;
  justify-content: center;
  margin-bottom: 1rem;
  text-align: center;
  vertical-align: center;
  align-items: center;
}

.logo > span {
  font-size: 28px;
  color: #263238;
  font-weight: bold;
}

.code {
  margin-right: 0;
}

:deep(.el-col>.el-input>.el-input__wrapper) {
  margin-right: 0.5rem;
}

.code-button {
  margin: 0;
  width: 106px;
  height: 42px;
}
</style>
